<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="icon" href="../assets/icon/logoSite.png" />
    <title>Roteirando | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="listarKpis(), obterDados()">
    <div class="container">
        <header>
        <div id="header-logo">
          <img src="../assets/icon/logoSite.png" alt="Logo Site" />
          <h2 class="nome-site">Roteirando</h2>
          <h2 class="nome-usuario">Olá, <span id="nome_usuario">Usuario</span></h2>
        </div>
        <ul id="navbar" on>
          <a class="button-navbar" href="viagem.html">
            <li class="content-button">
              Viagens
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/house-line-thin.svg"
                alt="icon login"
              />
            </li>
          </a>
          <a class="button-navbar" href="historico.html">
            <li class="content-button">
              Histórico
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
          <a class="page-atual" href="./dashboard.html">
            <li class="content-button">
              Dashboard
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
          <a class="button-navbar" href="./destino.html">
            <li class="content-button">
              Destinos
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
          <a class="button-navbar" href="../index.html">
            <li class="content-button">
              Sair
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
        </ul>
    </header>
  <!--header fim-->
  <section id="section_kpis">
      
  </section>
  </div>
  <div class="container">
    <section class="section-graficos">
      <div class="grafico">
        <label class="label-grafico">Regiões mais Visitadas:</label>
        <canvas id="myChart1"></canvas>
      </div>
      <div class="grafico barra">
        <label class="label-grafico">Média de Orçamento por região:</label>
        <canvas id="myChart2"></canvas>
      </div>
    </section>
  </div>
</body>
<script>
  nome_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  kpisBD = [];

  function listarKpis(){
    fetch("/viagens/buscarKPI", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        id_usuario: sessionStorage.ID_USUARIO
      }),
    })
      .then(function (resposta) {
        resposta.json().then((kpis) => {
          kpis.forEach((kpi) => {
            kpisBD.push(kpi);
          });
          verificaKpis();
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      }); 
  }
  function verificaKpis(){
    if(kpisBD.length<1){
      section_kpis.innerHTML = '<h2 style="color: black;">Comece a planejar sua viagem para ver as KPIs</h2>';
    }else{
      const umDia = 1000*60*60*24
      var dataAtual = new Date()
      var dataViagem = new Date(kpisBD[0].dtIda)
      var diasRestantes = ( dataViagem - dataAtual ) / umDia;
      
      section_kpis.innerHTML = `<div class="kpi">
        <label >Dias faltantes próxima viagem:</label>
        <span>${(diasRestantes).toFixed()}</span>
      </div>
      <div class="kpi">
        <label >Próximo Destino:</label>
        <span>${kpisBD[0].nome}</span>
      </div>
      <div class="kpi">
        <label >Para alcançar a meta:</label>
        <span>${(kpisBD[0].faltante<0 ? 'Meta Alcançada' : 'R$'+(kpisBD[0].faltante).toLocaleString('pt-br',{style:'currency', currency: 'BRL'}))}</span>
      </div>`;
    }
  }

  //gráficos
  var mediaSul = 0;
  var mediaSudeste = 0;
  var mediaNordeste = 0;
  const ctx2 = document.getElementById('myChart2');

   let myChart2 = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: [''],
      datasets: [{
        label: ['Sul'],
        data: [mediaSul],
        borderWidth: 1,
        backgroundColor: ['rgb(247, 86, 124)']
      },
    {
        label: ['Sudeste'],
        data: [mediaSudeste],
        borderWidth: 1,
        backgroundColor: ['rgb(65, 60, 88)']
      },
    {
        label: ['Nordeste'],
        data: [mediaNordeste],
        borderWidth: 1,
        backgroundColor: ['rgb(241, 153, 83)']
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  var viagensSul = 0;
  var viagensSudeste = 0;
  var viagensNordeste = 0;
  const ctx1 = document.getElementById('myChart1');

  let myChart1 = new Chart(ctx1, {
    type: 'doughnut',
    data: {
        labels: ['Sul','Nordeste', 'Sudeste'],
        datasets: [{
            label: 'Número de viagens:',
            data: [viagensSul, viagensSudeste, viagensNordeste],
            backgroundColor: [
                'rgb(247, 86, 124)',
                'rgb(241, 153, 83)',
                'rgb(65, 60, 88)'
            ],
            hoverOffset: 4
        },
      ]
    }
});

function obterDados(){
  fetch(`/viagens/buscarGraficos`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarGrafico(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
}
function plotarGrafico(resposta){
  if(resposta.length<1){
    section_graficos.innerHTML = '<h2>Nenhum dado encontrado para os gráficos.</h2>'
  }else{
    viagensNordeste = resposta[0].num_visitas;
    viagensSudeste = resposta[1].num_visitas;
    viagensSul = resposta[2].num_visitas;
    mediaNordeste = resposta[0].media_valor;
    mediaSudeste = resposta[1].media_valor;
    mediaSul = resposta[2].media_valor;

    myChart2.data.datasets[0].data = [mediaSul];
    myChart2.data.datasets[1].data = [mediaSudeste];
    myChart2.data.datasets[2].data = [mediaNordeste];
    myChart1.data.datasets[0].data = [ viagensSul,viagensNordeste,viagensSudeste];

    myChart1.update()
    myChart2.update()
  }
}

</script>
</html>