<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="icon" href="../assets/icon/logoSite.png" />
    <title>Roteirando | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
        <div id="header-logo">
          <img src="../assets/icon/logoSite.png" alt="Logo Site" />
          <h2 class="nome-site">Roteirando</h2>
          <h2 class="nome-usuario">Olá, <span id="nome_usuario">Usuario</span></h2>
        </div>
        <ul id="navbar" on>
          <a class="button-navbar" href="viagem.html">
            <li class="content-button">
              Viagens
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/house-line-thin.svg"
                alt="icon login"
              />
            </li>
          </a>
          <a class="button-navbar" href="historico.html">
            <li class="content-button">
              Histórico
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
          <a class="page-atual" href="./dashboard.html">
            <li class="content-button">
              Dashboard
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
          <a class="button-navbar" href="./destino.html">
            <li class="content-button">
              Destinos
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
          <a class="button-navbar" href="../index.html">
            <li class="content-button">
              Sair
              <img
                class="icon-navbar"
                src="../assets/imgs/icons/login.svg"
                alt="icon cadastrar"
              />
            </li>
          </a>
        </ul>
    </header>
  <!--header fim-->
  <section class="section-kpis">
      <div class="kpi">
        <label >Dias restantes próxima viagem:</label>
        <span>10</span>
      </div>
      <div class="kpi">
        <label >Próximo Destino:</label>
        <span>Rio De Janeiro</span>
      </div>
      <div class="kpi">
        <label >Para alcançar a meta:</label>
        <span>1000</span>
      </div>
  </section>
  </div>
  <div class="container">
    <section class="section-graficos">
      <div class="grafico">
        <label >Regiões mais Visitadas:</label>
        <canvas id="myChart1"></canvas>
      </div>
      <div class="grafico barra">
        <label >Média de Orçamento por região:</label>
        <canvas id="myChart2"></canvas>
      </div>
    </section>
  </div>
</body>
<script>
  nome_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  const ctx2 = document.getElementById('myChart2');

  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['Sul', 'Sudeste', 'Nordeste'],
      datasets: [{
        label: '# of Votes',
        data: [5000, 3600, 7000],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  const ctx1 = document.getElementById('myChart1');

  new Chart(ctx1, {
    type: 'doughnut',
    data: {
        labels: ['Sul','Nordeste', 'Sudeste'],
        datasets: [{
            label: 'Número de viagens',
            data: [300, 50, 100],
            backgroundColor: [
                'rgb(134, 186, 144)',
                'rgb(241, 153, 83)',
                'rgb(65, 60, 88)'
            ],
            hoverOffset: 4
        }]
    }
});


  function obterDadosGrafico(idAquario) {

        alterarTitulo(idAquario)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idAquario);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idAquario) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },
            {
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.temperatura);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idAquario}`),
            config
        );

        setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    }
</script>
</html>